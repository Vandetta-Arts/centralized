name: Issue Initializer

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]

jobs:
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      issue_number: ${{ steps.check.outputs.issue_number }}
      issue_title: ${{ steps.check.outputs.issue_title }}
    steps:
      - name: Check for trigger
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "issues" ]]; then
            BODY="${{ github.event.issue.body }}"
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
          else
            BODY="${{ github.event.comment.body }}"
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
          fi

          if [[ "$BODY" == *"@claude_issue_initializer"* ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            # Sanitize issue title for use in branch/folder names
            SANITIZED_TITLE=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//')
            echo "issue_title=$SANITIZED_TITLE" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  initialize-issue:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create feature branch
        run: |
          BRANCH_NAME="feature/issue-${{ needs.check-trigger.outputs.issue_number }}-${{ needs.check-trigger.outputs.issue_title }}"
          git config user.name "Claude Issue Initializer"
          git config user.email "claude-bot@example.com"

          # Check if branch already exists
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists, checking out"
            git fetch origin "$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
          else
            echo "Creating new branch $BRANCH_NAME"
            git checkout -b "$BRANCH_NAME"
            git push -u origin "$BRANCH_NAME"
          fi

      - name: Create automation directory
        run: |
          ISSUE_DIR=".automation/open/issue-${{ needs.check-trigger.outputs.issue_number }}"
          mkdir -p "$ISSUE_DIR"

          # Save initial issue contents
          cat > "$ISSUE_DIR/1_INITIAL_ISSUE_CONTENTS.md" << 'EOF'
          # Initial Issue Contents

          **Issue Number:** #${{ needs.check-trigger.outputs.issue_number }}
          **Issue Title:** ${{ github.event.issue.title }}
          **Created By:** ${{ github.event.issue.user.login }}
          **Created At:** ${{ github.event.issue.created_at }}

          ## Issue Body

          ${{ github.event.issue.body }}
          EOF

      - name: Run Claude Issue Initializer Agent
        uses: anthropics/claude-code@v1
        with:
          api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          agent_prompt_file: .claude/agents/issue-initializer.md
          context: |
            Issue Number: ${{ needs.check-trigger.outputs.issue_number }}
            Issue Title: ${{ github.event.issue.title }}
            Issue Body: ${{ github.event.issue.body }}
            Repository: ${{ github.repository }}
            Issue Dir: .automation/open/issue-${{ needs.check-trigger.outputs.issue_number }}
        id: claude_analysis

      - name: Save request for details
        run: |
          ISSUE_DIR=".automation/open/issue-${{ needs.check-trigger.outputs.issue_number }}"
          echo "${{ steps.claude_analysis.outputs.request_for_details }}" > "$ISSUE_DIR/2_REQUEST_FOR_DETAILS.md"

      - name: Commit automation files
        run: |
          ISSUE_DIR=".automation/open/issue-${{ needs.check-trigger.outputs.issue_number }}"
          git add "$ISSUE_DIR"
          git commit -m "Initialize automation for issue #${{ needs.check-trigger.outputs.issue_number }}" || echo "No changes to commit"
          git push || echo "Nothing to push"

      - name: Post clarification request
        uses: actions/github-script@v7
        with:
          script: |
            const request = `${{ steps.claude_analysis.outputs.request_for_details }}`;
            const footer = `\n\n---\n*This analysis was performed by Claude Issue Initializer. Please answer the questions above and tag @claude_scenarii when ready to proceed.*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.check-trigger.outputs.issue_number }},
              body: request + footer
            });