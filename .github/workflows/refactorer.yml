name: Refactorer

on:
  issue_comment:
    types: [created, edited]

jobs:
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      issue_number: ${{ steps.check.outputs.issue_number }}
    steps:
      - name: Check for trigger
        id: check
        run: |
          BODY="${{ github.event.comment.body }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"

          if [[ "$BODY" == *"@claude_refactoror"* ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  refactor-code:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get issue details
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.check-trigger.outputs.issue_number }}
            });

            const sanitizedTitle = issue.data.title
              .toLowerCase()
              .replace(/[^a-z0-9-]/g, '-')
              .replace(/--+/g, '-')
              .replace(/^-|-$/g, '');

            core.setOutput('title', issue.data.title);
            core.setOutput('sanitized_title', sanitizedTitle);

      - name: Switch to feature branch
        run: |
          BRANCH_NAME="feature/issue-${{ needs.check-trigger.outputs.issue_number }}-${{ steps.issue.outputs.sanitized_title }}"
          git config user.name "Claude Refactorer"
          git config user.email "claude-bot@example.com"

          git fetch origin "$BRANCH_NAME"
          git checkout "$BRANCH_NAME"
          git pull origin "$BRANCH_NAME"

      - name: Setup Node.js (if needed)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
        if: hashFiles('package.json') != ''

      - name: Install dependencies (if needed)
        run: |
          if [ -f "package.json" ]; then
            npm ci || npm install
          fi

      - name: Run tests before refactoring
        id: before_test
        run: |
          echo "Running tests to ensure they pass before refactoring..."

          if [ -f "package.json" ] && grep -q '"test"' package.json; then
            npm test 2>&1 | tee before_test_output.txt
            BEFORE_EXIT_CODE=${PIPESTATUS[0]}
          elif [ -f "Makefile" ] && grep -q '^test:' Makefile; then
            make test 2>&1 | tee before_test_output.txt
            BEFORE_EXIT_CODE=${PIPESTATUS[0]}
          elif [ -f "pytest.ini" ] || [ -f "setup.py" ]; then
            python -m pytest 2>&1 | tee before_test_output.txt
            BEFORE_EXIT_CODE=${PIPESTATUS[0]}
          else
            echo "No test runner detected" > before_test_output.txt
            BEFORE_EXIT_CODE=0
          fi

          if [ $BEFORE_EXIT_CODE -ne 0 ]; then
            echo "ERROR: Tests are failing before refactoring. Cannot proceed."
            exit 1
          fi

      - name: Check refactoring cycle count
        id: cycle_check
        run: |
          ISSUE_DIR=".automation/open/issue-${{ needs.check-trigger.outputs.issue_number }}"
          CYCLE_COUNT=1

          # Count existing refactoring plans
          for i in {1..10}; do
            if [ -f "$ISSUE_DIR/8_REFACTORING_PLAN_v${i}.md" ]; then
              CYCLE_COUNT=$((i + 1))
            fi
          done

          echo "cycle_count=$CYCLE_COUNT" >> $GITHUB_OUTPUT

          # Check if we've exceeded max cycles (default: 3)
          MAX_CYCLES="${{ vars.MAX_REFACTORING_CYCLES || '3' }}"
          if [ $CYCLE_COUNT -gt $MAX_CYCLES ]; then
            echo "max_exceeded=true" >> $GITHUB_OUTPUT
          else
            echo "max_exceeded=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Refactorer Agent
        if: steps.cycle_check.outputs.max_exceeded != 'true'
        uses: anthropics/claude-code@v1
        with:
          api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          agent_prompt_file: .claude/agents/refactoror.md
          model: claude-3-opus-latest
          context: |
            Issue Number: ${{ needs.check-trigger.outputs.issue_number }}
            Issue Title: ${{ steps.issue.outputs.title }}
            Repository: ${{ github.repository }}
            Issue Dir: .automation/open/issue-${{ needs.check-trigger.outputs.issue_number }}
            Refactoring Cycle: ${{ steps.cycle_check.outputs.cycle_count }}
            TDD Phase: REFACTOR - Improve code quality while maintaining test success
            Refactoring Goals:
            - Remove duplicate code
            - Improve naming and readability
            - Split large methods into smaller pieces
            - Optimize performance
            - Apply design patterns where appropriate
            - Remove hard-coded values
        id: claude_refactor

      - name: Save refactoring plan
        if: steps.cycle_check.outputs.max_exceeded != 'true'
        run: |
          ISSUE_DIR=".automation/open/issue-${{ needs.check-trigger.outputs.issue_number }}"
          CYCLE="${{ steps.cycle_check.outputs.cycle_count }}"

          if [ "$CYCLE" -eq 1 ]; then
            echo "${{ steps.claude_refactor.outputs.refactoring_plan }}" > "$ISSUE_DIR/8_REFACTORING_PLAN.md"
          else
            echo "${{ steps.claude_refactor.outputs.refactoring_plan }}" > "$ISSUE_DIR/8_REFACTORING_PLAN_v${CYCLE}.md"
          fi

      - name: Apply refactoring
        if: steps.cycle_check.outputs.max_exceeded != 'true'
        run: |
          echo "${{ steps.claude_refactor.outputs.refactored_files }}" | base64 -d | tar -xzf -

      - name: Run tests after refactoring
        if: steps.cycle_check.outputs.max_exceeded != 'true'
        id: after_test
        run: |
          echo "Running tests to ensure they still pass after refactoring..."

          if [ -f "package.json" ] && grep -q '"test"' package.json; then
            npm test 2>&1 | tee after_test_output.txt
            AFTER_EXIT_CODE=${PIPESTATUS[0]}
          elif [ -f "Makefile" ] && grep -q '^test:' Makefile; then
            make test 2>&1 | tee after_test_output.txt
            AFTER_EXIT_CODE=${PIPESTATUS[0]}
          elif [ -f "pytest.ini" ] || [ -f "setup.py" ]; then
            python -m pytest 2>&1 | tee after_test_output.txt
            AFTER_EXIT_CODE=${PIPESTATUS[0]}
          else
            echo "No test runner detected" > after_test_output.txt
            AFTER_EXIT_CODE=0
          fi

          if [ $AFTER_EXIT_CODE -eq 0 ]; then
            echo "test_status=passing" >> $GITHUB_OUTPUT
          else
            echo "test_status=failing" >> $GITHUB_OUTPUT
          fi

      - name: Run code quality checks
        if: steps.cycle_check.outputs.max_exceeded != 'true' && steps.after_test.outputs.test_status == 'passing'
        id: quality_check
        continue-on-error: true
        run: |
          QUALITY_SCORE=0
          MAX_SCORE=0

          # JavaScript/TypeScript linting
          if [ -f "package.json" ]; then
            if grep -q '"lint"' package.json; then
              MAX_SCORE=$((MAX_SCORE + 1))
              npm run lint && QUALITY_SCORE=$((QUALITY_SCORE + 1)) || true
            fi
          fi

          # Python linting
          if [ -f "setup.py" ] || [ -f "pyproject.toml" ]; then
            MAX_SCORE=$((MAX_SCORE + 1))
            python -m pylint **/*.py --exit-zero && QUALITY_SCORE=$((QUALITY_SCORE + 1)) || true
          fi

          echo "quality_score=$QUALITY_SCORE" >> $GITHUB_OUTPUT
          echo "max_score=$MAX_SCORE" >> $GITHUB_OUTPUT

      - name: Commit refactoring
        if: steps.cycle_check.outputs.max_exceeded != 'true' && steps.after_test.outputs.test_status == 'passing'
        run: |
          CYCLE="${{ steps.cycle_check.outputs.cycle_count }}"
          git add -A
          git commit -m "Refactor code for issue #${{ needs.check-trigger.outputs.issue_number }} (TDD Refactor phase, cycle $CYCLE)" || echo "No changes to commit"
          git push || echo "Nothing to push"

      - name: Determine next action
        id: next_action
        run: |
          MAX_EXCEEDED="${{ steps.cycle_check.outputs.max_exceeded }}"
          TEST_STATUS="${{ steps.after_test.outputs.test_status }}"
          NEEDS_MORE="${{ steps.claude_refactor.outputs.needs_more_refactoring }}"
          CYCLE="${{ steps.cycle_check.outputs.cycle_count }}"

          if [ "$MAX_EXCEEDED" == "true" ]; then
            echo "action=max_cycles" >> $GITHUB_OUTPUT
          elif [ "$TEST_STATUS" == "failing" ]; then
            echo "action=tests_broken" >> $GITHUB_OUTPUT
          elif [ "$NEEDS_MORE" == "true" ] && [ "$CYCLE" -lt 3 ]; then
            echo "action=continue_refactoring" >> $GITHUB_OUTPUT
          else
            echo "action=complete" >> $GITHUB_OUTPUT
          fi

      - name: Post refactoring results
        uses: actions/github-script@v7
        with:
          script: |
            const action = '${{ steps.next_action.outputs.action }}';
            const cycle = '${{ steps.cycle_check.outputs.cycle_count }}';
            let body;

            switch(action) {
              case 'max_cycles':
                body = `## Refactoring Cycle Limit Reached ⚠️\n\nMaximum number of refactoring cycles (3) has been reached.\n\n### Summary\n- Completed ${cycle - 1} refactoring cycles\n- Code has been iteratively improved\n- Ready for pull request creation\n\n---\n*Proceeding to create pull request. Tag @claude_pr_creator or manually create PR.*`;
                break;

              case 'tests_broken':
                body = `## Refactoring Failed ❌\n\nTests are failing after refactoring attempt (cycle ${cycle}).\n\n### Issue\nRefactoring broke existing functionality. The changes have been reverted.\n\n*Manual intervention required. Please review the refactoring attempt and fix the issues.*`;
                break;

              case 'continue_refactoring':
                body = `## Refactoring Cycle ${cycle} Complete ♻️\n\nRefactoring applied successfully. Tests are still passing.\n\n### Improvements Made\n${{ steps.claude_refactor.outputs.improvements_summary }}\n\n### Code Quality\nThe code can benefit from additional refactoring.\n\n---\n*Initiating refactoring cycle ${parseInt(cycle) + 1}. Tagging @claude_refactoror to continue improvements.*`;
                break;

              case 'complete':
                body = `## Refactoring Complete ✅\n\nAll refactoring cycles completed successfully (cycle ${cycle}).\n\n### Final Improvements\n${{ steps.claude_refactor.outputs.improvements_summary }}\n\n### Test Status\n✅ All tests passing\n\n### Code Quality Assessment\nCode meets quality standards and is ready for review.\n\n---\n*TDD cycle complete! Ready to create pull request. Tag @claude_pr_creator or manually create PR.*`;
                break;

              default:
                body = `## Refactoring Status Unknown\n\nUnexpected state encountered. Manual review required.`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.check-trigger.outputs.issue_number }},
              body: body
            });