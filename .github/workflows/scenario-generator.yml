name: Scenario Generator

on:
  issue_comment:
    types: [created, edited]

jobs:
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      issue_number: ${{ steps.check.outputs.issue_number }}
    steps:
      - name: Check for trigger
        id: check
        run: |
          BODY="${{ github.event.comment.body }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"

          if [[ "$BODY" == *"@claude_scenarii"* ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  generate-scenarios:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get issue details
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.check-trigger.outputs.issue_number }}
            });

            const sanitizedTitle = issue.data.title
              .toLowerCase()
              .replace(/[^a-z0-9-]/g, '-')
              .replace(/--+/g, '-')
              .replace(/^-|-$/g, '');

            core.setOutput('title', issue.data.title);
            core.setOutput('sanitized_title', sanitizedTitle);
            core.setOutput('body', issue.data.body);

      - name: Switch to feature branch
        run: |
          BRANCH_NAME="feature/issue-${{ needs.check-trigger.outputs.issue_number }}-${{ steps.issue.outputs.sanitized_title }}"
          git config user.name "Claude Scenario Generator"
          git config user.email "claude-bot@example.com"

          git fetch origin "$BRANCH_NAME"
          git checkout "$BRANCH_NAME"
          git pull origin "$BRANCH_NAME"

      - name: Save user details
        run: |
          ISSUE_DIR=".automation/open/issue-${{ needs.check-trigger.outputs.issue_number }}"

          cat > "$ISSUE_DIR/3_USER_DETAILS.md" << 'EOF'
          # User Details Response

          **Response By:** ${{ github.event.comment.user.login }}
          **Response At:** ${{ github.event.comment.created_at }}

          ## User Response

          ${{ github.event.comment.body }}
          EOF

      - name: Get conversation history
        id: conversation
        uses: actions/github-script@v7
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.check-trigger.outputs.issue_number }}
            });

            const conversation = comments.data.map(c => ({
              author: c.user.login,
              created_at: c.created_at,
              body: c.body
            }));

            core.setOutput('history', JSON.stringify(conversation));

      # NOTE: Claude integration placeholder
      # In production, this would call Claude API or use a custom action
      - name: Generate scenarios
        id: claude_scenarios
        run: |
          ISSUE_DIR=".automation/open/issue-${{ needs.check-trigger.outputs.issue_number }}"

          # Create complete instructions
          cat > "$ISSUE_DIR/4_COMPLETE_INSTRUCTIONS.md" << 'EOF'
          # Complete Implementation Instructions

          ## Feature Overview
          Based on the issue and clarifications provided, implement the requested feature.

          ## Detailed Requirements

          ### Functional Requirements
          - Implement the core functionality as described
          - Handle all specified use cases
          - Provide appropriate error handling

          ### Technical Specifications
          - Follow existing code patterns
          - Use appropriate design patterns
          - Ensure code is testable

          ### Validation Rules
          - Validate all inputs
          - Provide clear error messages
          - Handle edge cases gracefully
          EOF

          # Create test scenarios
          cat > "$ISSUE_DIR/5_SCENARIOS.md" << 'EOF'
          # Test Scenarios

          ## Happy Path Scenarios
          - **Scenario 1.1**: Basic successful operation
            - Given: Valid input
            - When: Operation is performed
            - Then: Expected output is produced

          ## Edge Cases
          - **Scenario 2.1**: Empty input handling
            - Given: Empty input
            - When: Operation is attempted
            - Then: Appropriate handling/error

          ## Error Scenarios
          - **Scenario 3.1**: Invalid input
            - Given: Invalid input
            - When: Operation is attempted
            - Then: Error is returned

          ## Integration Scenarios
          - **Scenario 4.1**: Component interaction
            - Given: Multiple components
            - When: They interact
            - Then: Correct behavior observed
          EOF

          # Set outputs
          INSTRUCTIONS=$(cat "$ISSUE_DIR/4_COMPLETE_INSTRUCTIONS.md")
          SCENARIOS=$(cat "$ISSUE_DIR/5_SCENARIOS.md")

          echo "complete_instructions<<EOF" >> $GITHUB_OUTPUT
          echo "$INSTRUCTIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "scenarios<<EOF" >> $GITHUB_OUTPUT
          echo "$SCENARIOS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Commit scenario files
        run: |
          ISSUE_DIR=".automation/open/issue-${{ needs.check-trigger.outputs.issue_number }}"
          git add "$ISSUE_DIR"
          git commit -m "Generate scenarios for issue #${{ needs.check-trigger.outputs.issue_number }}" || echo "No changes to commit"
          git push || echo "Nothing to push"

      - name: Post scenarios and tag test implementor
        uses: actions/github-script@v7
        with:
          script: |
            const instructions = `${{ steps.claude_scenarios.outputs.complete_instructions }}`;
            const scenarios = `${{ steps.claude_scenarios.outputs.scenarios }}`;

            const body = `## Complete Instructions\n\n${instructions}\n\n## Test Scenarios\n\n${scenarios}\n\n---\n*Scenarios generated. Tagging @claude_test_implementor to create failing tests following TDD principles.*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.check-trigger.outputs.issue_number }},
              body: body
            });